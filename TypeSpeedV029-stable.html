<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å­—ç·´ç¿’å·¥å…·</title>
    <style>
        /* éœé¶©æ–‡æ¥· */
@import url('https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css');
/* é¦¬å–„æ”¿æ‰‹å¯«é«” */
@import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');
/* ç«™é…·å°å¾®é«” */
@import url('https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&display=swap');
/* æ±Ÿè¥¿æ‹™æ¥·  */
@import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+QingKe+HuangYou&display=swap');
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .control-panel {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .control-group {
            margin: 10px 0;
        }
        button, select {
            padding: 8px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button {
            background-color: #4CAF50;
            color: white;
        }
        button:hover {
            background-color: #45a049;
        }
        select {
            background-color: #f1f1f1;
        }
.typing-area {
    border: 1px solid #ddd;
    padding: 15px;
    min-height: 600px;
    margin-bottom: 20px;
    background-color: #f9f9f9;
    border-radius: 4px;
}
#text-display {
    font-size: 25px;
    line-height: 1.6;
    height: 450px;
    color: #333;
    overflow-y: auto;
    white-space: pre-wrap;
    scroll-behavior: smooth; /* æ·»åŠ å¹³æ»‘æ»¾å‹•æ•ˆæœ */
}
        #text-input {
            width: 100%;
            padding: 10px;
            font-size: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            overflow-y: auto;
            height: 400px;
            resize: none;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 10px;
            background-color: #e9e9e9;
            border-radius: 4px;
        }
        .stat-box {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
            text-decoration: underline;
        }
        .current {
            background-color: #ffffcc;
        }
        .file-upload {
            margin: 10px 0;
        }
        .practice-mode {
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
        }
        .practice-mode label {
            margin-left: 5px;
        }
        .finished-incorrect {
            background-color: yellow;
            text-decoration: underline;
        }
        #input-display {
            width: 100%;
            padding: 10px;
            font-size: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: white;
        }
        .input-correct {
            color: black;
        }
        .input-incorrect {
            color: red;
            text-decoration: underline;
        }
        .drop-area {
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .drop-area.highlight {
            border-color: #4CAF50;
            background-color: #f0fff0;
        }
        .file-list {
            margin-top: 10px;
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
            transition: max-height 0.3s;
        }
        .file-list.collapsed {
            max-height: 0;
            overflow: hidden;
            border: none;
            padding: 0;
        }
        .file-item {
            margin: 3px 0;
            font-size: 14px;
        }
        .web-search-panel {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        .web-search-panel select {
            flex: 1;
        }
        .web-search-panel button {
            flex: 0 0 auto;
        }

:root {
    --correct-color: #008000;
    --incorrect-color: #ff0000;
}

.correct {
    color: var(--correct-color);
}

.incorrect, .finished-incorrect {
    color: var(--incorrect-color);
    text-decoration: underline;
}

.input-incorrect {
    color: var(--incorrect-color);
    text-decoration: underline;
}

.window-btn {
    position: fixed;
    top: 10px;
    left: 10px;
    width: 30px;
    height: 30px;
    background-color: purple;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    user-select: none;
}

.window-icon {
    color: white;
    font-size: 16px;
    font-family: Arial, sans-serif;
}

    </style>
</head>
<body>
    <div class="container">
        <h1>æ‰“å­—ç·´ç¿’å·¥å…·</h1>
        

<div class="window-btn" title="å·¦éµ:æ–°è¦–çª— ä¸­éµ:æ–°åˆ†é  æ»¾è¼ª:ç¸®æ”¾ å³éµ:é‡ç½®">
    <span class="window-icon">ğŸ—”</span>
</div>        
        <div class="control-panel">
            <div class="control-group">
                <label for="time-select">ç·´ç¿’æ™‚é–“ï¼š</label>
                <select id="time-select">
                    <option value="60">1åˆ†é˜</option>
                    <option value="300">5åˆ†é˜</option>
                    <option value="600" selected>10åˆ†é˜</option>
                    <option value="900">15åˆ†é˜</option>
                    <option value="1800">30åˆ†é˜</option>
                    <option value="2700">45åˆ†é˜</option>
                    <option value="3600">1å°æ™‚</option>
                    <option value="7200">2å°æ™‚</option>
                    <option value="10800">4å°æ™‚</option>
                </select>
            </div>
            
<div class="control-group">
                    <button id="start-btn">é–‹å§‹ç·´ç¿’</button>
                <button id="reset-btn">é‡æ–°é–‹å§‹</button>
    <div class="practice-mode">
        <input type="checkbox" id="practice-mode" checked>
        <label for="practice-mode">ç·´ç¿’æ¨¡å¼</label>
    </div>
    <select id="font-select">
        <option value="'Microsoft JhengHei', Arial, sans-serif">é è¨­å­—å‹</option>
        <option value="'DFKai-SB', serif">æ¨™æ¥·é«”</option>
        <option value="'SimSun', serif">å®‹é«”</option>
        <option value="'SimHei', sans-serif">é»‘é«”</option>
        <option value="'KaiTi', serif">æ¥·é«”</option>
        <option value="'Courier New', monospace">ç­‰å¯¬å­—å‹</option>
  <option value="'LXGW WenKai', 'KaiTi', serif">éœé¶©æ–‡æ¥·</option>
  <option value="'Ma Shan Zheng', cursive">é¦¬å–„æ”¿æ‰‹å¯«é«”</option>
  <option value="'ZCOOL XiaoWei', cursive">ç«™é…·å°å¾®é«”</option>
  <option value="'Jiangxi Zhuokai', serif">æ±Ÿè¥¿æ‹™æ¥·</option>


    </select>
</div>

<div class="control-group">
    <label for="correct-color">æ­£ç¢ºé¡è‰²ï¼š</label>
    <input type="color" id="correct-color" value="#008000">
    <label for="incorrect-color">éŒ¯èª¤é¡è‰²ï¼š</label>
    <input type="color" id="incorrect-color" value="#ff0000">
</div>
            
            <div class="control-group">
                <label for="essay-select">é¸æ“‡æ–‡ç« ï¼š</label>
                <select id="essay-select">
                    <option value="random" selected>éš¨æ©Ÿå…§éƒ¨æ–‡ç« </option>
                    <option value="upload">ä¸Šå‚³å¤–éƒ¨æ–‡ç« </option>
                    <option value="web">å¾ç¶²é éš¨æ©Ÿæ‰¾</option>
                </select>
            </div>
        </div>
        
        <div class="file-upload" id="upload-area" style="display: none;">
            <input type="file" id="txt-upload" accept=".txt" multiple>
            <button id="upload-btn">ä¸Šå‚³æ–‡ç« </button>
            <div id="drop-area" class="drop-area">
                <p>æ‹–æ”¾TXTæ–‡ä»¶åˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡æ–‡ä»¶</p>
                <div id="file-list" class="file-list"></div>
            </div>
        </div>
        
        <div id="web-search-area" style="display: none;">
            <div class="web-search-panel">
                <select id="web-language">
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="en">è‹±æ–‡</option>
                </select>
                <select id="web-source">
                    <option value="wikipedia">ç¶­åŸºç™¾ç§‘</option>
                    <option value="ltn">è‡ªç”±æ™‚å ±</option>
                </select>
                <button id="web-generate-btn">ç²å–æ–‡ç« </button>
            </div>
        </div>
        
        <div class="typing-area">
            <div id="text-display">è«‹é»æ“Šã€Œé–‹å§‹ç·´ç¿’ã€æŒ‰éˆ•é–‹å§‹æ‰“å­—æ¸¬è©¦</div>
            <textarea id="text-input" placeholder="ç•¶ç·´ç¿’é–‹å§‹æ™‚ï¼Œè«‹åœ¨æ­¤è¼¸å…¥æ–‡å­—..." disabled></textarea>
        </div>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-label">æ™‚é–“</div>
                <div class="stat-value" id="timer">00:00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">é€Ÿåº¦</div>
                <div class="stat-value" id="speed">0</div>
                <div>å­—/åˆ†é˜</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">æº–ç¢ºç‡</div>
                <div class="stat-value" id="accuracy">0%</div>
            </div>
        </div>
    </div>

    <script>


const btn = document.querySelector('.window-btn');
let scale = 1;

btn.addEventListener('click', (e) => {
    e.preventDefault();
    window.open(window.location.href, '_blank', 'width=800,height=600');
});

btn.addEventListener('auxclick', (e) => {
    if (e.button === 1) {
        e.preventDefault();
        window.open(window.location.href, '_blank');
    }
});

btn.addEventListener('wheel', (e) => {
    e.preventDefault();
    if (e.deltaY < 0) {
        scale += 0.1;
    } else {
        scale -= 0.1;
    }
    scale = Math.max(0.1, Math.min(scale, 3));
    document.body.style.transform = `scale(${scale})`;
    document.body.style.transformOrigin = '0 0';
});

btn.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    scale = 1;
    document.body.style.transform = 'scale(1)';
    location.reload();
});

        // é è¨­æ–‡ç« åº«
        const essays = [
            "æ‰“å­—ç·´ç¿’æ˜¯æé«˜è¼¸å…¥æ•ˆç‡çš„æœ‰æ•ˆæ–¹æ³•ã€‚é€šéæŒçºŒçš„ç·´ç¿’ï¼Œä½ å¯ä»¥é€æ¼¸æé«˜æ‰“å­—é€Ÿåº¦å’Œæº–ç¢ºç‡ã€‚å»ºè­°æ¯å¤©èŠ±ä¸€äº›æ™‚é–“é€²è¡Œæ‰“å­—ç·´ç¿’ï¼Œæ³¨æ„ä¿æŒæ­£ç¢ºçš„æ‰‹æŒ‡ä½ç½®å’Œå§¿å‹¢ã€‚",
            "é›»è…¦æŠ€è¡“çš„ç™¼å±•æ—¥æ–°æœˆç•°ï¼Œå¾æ—©æœŸçš„æ©Ÿæ¢°å¼éµç›¤åˆ°ç¾åœ¨çš„è§¸æ§è¼¸å…¥ï¼Œè¼¸å…¥æ–¹å¼ä¸æ–·æ¼”è®Šã€‚ç„¶è€Œï¼Œéµç›¤è¼¸å…¥ä»ç„¶æ˜¯ç›®å‰æœ€æœ‰æ•ˆç‡çš„æ–‡å­—è¼¸å…¥æ–¹å¼ä¹‹ä¸€ï¼Œç‰¹åˆ¥æ˜¯åœ¨éœ€è¦å¤§é‡æ–‡å­—è™•ç†çš„å·¥ä½œä¸­ã€‚",
            "å­¸ç¿’æ‰“å­—ä¸åƒ…å¯ä»¥æé«˜å·¥ä½œæ•ˆç‡ï¼Œé‚„èƒ½æ¸›å°‘å› é•·æ™‚é–“ä½¿ç”¨é›»è…¦è€Œç”¢ç”Ÿçš„ç–²å‹ã€‚æ­£ç¢ºçš„æ‰“å­—å§¿å‹¢åŒ…æ‹¬é›™æ‰‹æ”¾åœ¨åŸºæœ¬éµä½ã€æ‰‹è…•ä¿æŒè‡ªç„¶å§¿å‹¢ã€çœ¼ç›ç›¡é‡ä¸çœ‹éµç›¤ç­‰ã€‚",
            "åœ¨æ•¸ä½æ™‚ä»£ï¼Œæ‰“å­—å·²æˆç‚ºä¸€é …åŸºæœ¬æŠ€èƒ½ã€‚ç„¡è«–æ˜¯å­¸ç”Ÿã€ä¸Šç­æ—é‚„æ˜¯è‡ªç”±å·¥ä½œè€…ï¼Œå¿«é€Ÿæº–ç¢ºçš„æ‰“å­—èƒ½åŠ›éƒ½èƒ½ç‚ºå·¥ä½œå’Œå­¸ç¿’å¸¶ä¾†ä¾¿åˆ©ã€‚æ‰“å­—ç·´ç¿’æ‡‰è©²æ³¨é‡æº–ç¢ºæ€§è€Œéé€Ÿåº¦ï¼Œéš¨è‘—ç·´ç¿’çš„å¢åŠ ï¼Œé€Ÿåº¦è‡ªç„¶æœƒæå‡ã€‚",
            "æ‰“å­—é€Ÿåº¦çš„æ¸¬é‡é€šå¸¸ä»¥æ¯åˆ†é˜èƒ½è¼¸å…¥çš„å­—æ•¸ç‚ºå–®ä½ã€‚ä¸€èˆ¬äººçš„æ‰“å­—é€Ÿåº¦ç´„ç‚º30-50å­—/åˆ†é˜ï¼Œç¶“éè¨“ç·´å¯ä»¥é”åˆ°80-120å­—/åˆ†é˜ã€‚å°ˆæ¥­æ‰“å­—å“¡çš„é€Ÿåº¦ç”šè‡³å¯ä»¥è¶…é150å­—/åˆ†é˜ã€‚"
        ];

        function getRandomEssay() {
    return essays[Math.floor(Math.random() * essays.length)];
}
        
        // ç¶²é æ–‡ç« ä¾†æºé…ç½®
        const sourceOptions = {
            zh: [
                { value: 'wikipedia', text: 'ç¶­åŸºç™¾ç§‘', url: 'https://zh.wikipedia.org/w/api.php' },
                { value: 'ltn', text: 'è‡ªç”±æ™‚å ±', url: 'https://api.rss2json.com/v1/api.json?rss_url=https://news.ltn.com.tw/rss/all.xml' },
            ],
            en: [
                { value: 'wikipedia', text: 'Wikipedia', url: 'https://en.wikipedia.org/w/api.php' },
                { value: 'bbc', text: 'BBC News', url: 'https://api.rss2json.com/v1/api.json?rss_url=https://feeds.bbci.co.uk/news/rss.xml' },
            ]
        };
        
        // DOM å…ƒç´ 
        const textDisplay = document.getElementById('text-display');
        const textInput = document.getElementById('text-input');
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');
        const timerDisplay = document.getElementById('timer');
        const speedDisplay = document.getElementById('speed');
        const accuracyDisplay = document.getElementById('accuracy');
        const timeSelect = document.getElementById('time-select');
        const essaySelect = document.getElementById('essay-select');
        const uploadArea = document.getElementById('upload-area');
        const txtUpload = document.getElementById('txt-upload');
        const uploadBtn = document.getElementById('upload-btn');
        const practiceMode = document.getElementById('practice-mode');
        const dropArea = document.getElementById('drop-area');
        const fileList = document.getElementById('file-list');
        const webSearchArea = document.getElementById('web-search-area');
        const webLanguage = document.getElementById('web-language');
        const webSource = document.getElementById('web-source');
        const webGenerateBtn = document.getElementById('web-generate-btn');
        
        const fontSelect = document.getElementById('font-select');
const correctColor = document.getElementById('correct-color');
const incorrectColor = document.getElementById('incorrect-color');

// æ–°å¢äº‹ä»¶ç›£è½

        // è®Šæ•¸
        let timer;
        let timeLeft;
        let isTyping = false;
        let startTime;
        let totalTyped = 0;
        let correctTyped = 0;
        let currentEssay = "";
        let userUploadedEssays = [];
        let charStatus = [];
        let isComposing = false;
        let currentCharIndex = 0;
        
        // äº‹ä»¶ç›£è½
        startBtn.addEventListener('click', startTyping);
        resetBtn.addEventListener('click', resetTyping);
        textInput.addEventListener('input', checkTyping);
        textInput.addEventListener('compositionstart', function() { isComposing = true; });
        textInput.addEventListener('compositionend', function() { isComposing = false; checkTyping(); });
        essaySelect.addEventListener('change', toggleSourceArea);
        uploadBtn.addEventListener('click', handleFileUpload);
        txtUpload.addEventListener('change', handleFileUpload);
        webLanguage.addEventListener('change', updateWebSources);
        webGenerateBtn.addEventListener('click', fetchWebArticle);

        fontSelect.addEventListener('change', updateFontStyle);
correctColor.addEventListener('change', updateColorStyles);
incorrectColor.addEventListener('change', updateColorStyles);
        
        
        // æ‹–æ”¾ç›¸é—œäº‹ä»¶
        dropArea.addEventListener('click', () => txtUpload.click());
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('highlight');
        });
        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('highlight');
        });
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('highlight');
            if (e.dataTransfer.files.length) {
                txtUpload.files = e.dataTransfer.files;
                handleFileUpload();
            }
        });
        
        // åˆå§‹åŒ–ç¶²é ä¾†æºé¸å–®
        updateWebSources();
        
// æ–°å¢å‡½æ•¸
function updateFontStyle() {
    const fontFamily = fontSelect.value;
    textDisplay.style.fontFamily = fontFamily;
    textInput.style.fontFamily = fontFamily;
    const inputDisplay = document.getElementById('input-display');
    if (inputDisplay) {
        inputDisplay.style.fontFamily = fontFamily;
    }
}

function updateColorStyles() {
    const correct = correctColor.value;
    const incorrect = incorrectColor.value;
    
    // æ›´æ–° CSS è®Šæ•¸
    document.documentElement.style.setProperty('--correct-color', correct);
    document.documentElement.style.setProperty('--incorrect-color', incorrect);
    
    // æ›´æ–°ç¾æœ‰æ¨£å¼
    const correctSpans = document.querySelectorAll('.correct');
    const incorrectSpans = document.querySelectorAll('.incorrect, .finished-incorrect');
    const inputCorrect = document.querySelectorAll('.input-correct');
    const inputIncorrect = document.querySelectorAll('.input-incorrect');
    
    correctSpans.forEach(span => span.style.color = correct);
    incorrectSpans.forEach(span => span.style.color = incorrect);
    inputCorrect.forEach(span => span.style.color = 'black');
    inputIncorrect.forEach(span => span.style.color = incorrect);
}



        // åˆ‡æ›ä¾†æºå€åŸŸé¡¯ç¤º
        function toggleSourceArea() {
            const selectedOption = essaySelect.value;
            uploadArea.style.display = selectedOption === 'upload' ? 'block' : 'none';
            webSearchArea.style.display = selectedOption === 'web' ? 'block' : 'none';
            
            // è‡ªå‹•æŠ˜ç–Šæ‹–æ”¾å€åŸŸ
            if (selectedOption !== 'upload') {
                fileList.classList.add('collapsed');
            }
        }
        
        // æ›´æ–°ç¶²é ä¾†æºé¸å–®
        function updateWebSources() {
            const language = webLanguage.value;
            webSource.innerHTML = '';
            sourceOptions[language].forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.text;
                webSource.appendChild(opt);
            });
        }
        
        // å¾ç¶²é ç²å–æ–‡ç« 
        async function fetchWebArticle() {
            const language = webLanguage.value;
            const source = webSource.value;
            
            try {
                let paragraphs = [];
                if (source === 'wikipedia') {
                    const wikiUrl = sourceOptions[language].find(opt => opt.value === 'wikipedia').url;
                    const response = await fetch(`${wikiUrl}?action=query&format=json&list=random&rnlimit=1&rnnamespace=0&origin=*`);
                    const data = await response.json();
                    const pageId = data.query.random[0].id;
                    const contentResponse = await fetch(`${wikiUrl}?action=query&format=json&prop=extracts&pageids=${pageId}&exsectionformat=plain&origin=*`);
                    const contentData = await contentResponse.json();
                    const extract = contentData.query.pages[pageId].extract;
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = extract;
                    paragraphs = Array.from(tempDiv.getElementsByTagName('p'))
                        .map(p => p.textContent.trim())
                        .filter(p => p.length >= 50 && p.length <= 300);
                } else {
                    const rssUrl = sourceOptions[language].find(opt => opt.value === source).url;
                    const response = await fetch(rssUrl);
                    const data = await response.json();
                    const items = data.items || [];
                    paragraphs = items
                        .map(item => item.description || item.content || '')
                        .filter(text => text.length >= 50 && text.length <= 300);
                }
                
                if (paragraphs.length > 0) {
                    currentEssay = paragraphs.join('\n\n');
                    textDisplay.textContent = currentEssay;
                    alert('æ–‡ç« å·²æˆåŠŸè¼‰å…¥ï¼Œè«‹é»æ“Šã€Œé–‹å§‹ç·´ç¿’ã€æŒ‰éˆ•é–‹å§‹ç·´ç¿’');
                } else {
                    alert('æœªæ‰¾åˆ°åˆé©çš„æ–‡ç« æ®µè½ï¼Œè«‹å˜—è©¦å…¶ä»–ä¾†æºæˆ–èªè¨€');
                }
            } catch (error) {
                console.error('Error fetching web article:', error);
                alert('ç„¡æ³•åŠ è¼‰æ–‡ç« ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥ç¶²è·¯é€£æ¥');
            }
        }
        
        // è™•ç†æ–‡ä»¶ä¸Šå‚³
        function handleFileUpload() {
            const files = txtUpload.files;
            if (!files || files.length === 0) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æˆ–å¤šå€‹ TXT æ–‡ä»¶');
                return;
            }
            
            userUploadedEssays = [];
            fileList.innerHTML = '';
            fileList.classList.remove('collapsed');
            
            let filesProcessed = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    userUploadedEssays.push(e.target.result);
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.textContent = file.name;
                    fileList.appendChild(fileItem);
                    
                    filesProcessed++;
                    if (filesProcessed === files.length) {
                        alert(`æˆåŠŸä¸Šå‚³ ${files.length} å€‹æ–‡ä»¶ï¼`);
                        // è‡ªå‹•æŠ˜ç–Šæ‹–æ”¾å€åŸŸ
                        setTimeout(() => {
                            fileList.classList.add('collapsed');
                        }, 3000);
                    }
                };
                
                reader.onerror = function() {
                    alert(`è®€å–æ–‡ä»¶ ${file.name} æ™‚ç™¼ç”ŸéŒ¯èª¤`);
                    filesProcessed++;
                };
                
                reader.readAsText(file, 'UTF-8');
            }
        }
        
        // é–‹å§‹æ‰“å­—ç·´ç¿’
function startTyping() {
    if (isTyping) return;
    
    // é¸æ“‡æ–‡ç« 
    if (essaySelect.value === 'upload') {
        if (userUploadedEssays.length === 0) {
            alert('è«‹å…ˆä¸Šå‚³è‡ªè¨‚æ–‡ç« æˆ–é¸æ“‡éš¨æ©Ÿæ–‡ç« ');
            return;
        }
        currentEssay = userUploadedEssays[Math.floor(Math.random() * userUploadedEssays.length)];
    } else if (essaySelect.value === 'random') {
        currentEssay = getRandomEssay();
    } else if (essaySelect.value === 'web' && !currentEssay) {
        alert('è«‹å…ˆä½¿ç”¨ã€Œç²å–æ–‡ç« ã€æŒ‰éˆ•å¾ç¶²é è¼‰å…¥æ–‡ç« ');
        return;
    }
    
    // åˆå§‹åŒ–å­—ç¬¦ç‹€æ…‹é™£åˆ—
    charStatus = new Array(currentEssay.length).fill(null);
    currentCharIndex = 0;
    
    // é‡ç½®ç‹€æ…‹
    resetTyping(true);
    
    // è¨­ç½®æ–‡ç« é¡¯ç¤º
    displayEssay();
    
    // å•Ÿç”¨è¼¸å…¥æ¡†
    textInput.disabled = false;
    textInput.focus();
    
    // è¨­ç½®è¨ˆæ™‚å™¨
    timeLeft = parseInt(timeSelect.value);
    updateTimerDisplay();
    
    timer = setInterval(function() {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
            finishTyping();
        }
    }, 1000);
    
    startTime = new Date().getTime();
    isTyping = true;
    
    // æ–°å¢: æ»¾å‹•åˆ°æ‰“å­—å€åŸŸé ‚éƒ¨
    const typingArea = document.querySelector('.typing-area');
    typingArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
    

}
        
        // ç²å–éš¨æ©Ÿæ–‡ç« 
    function startTyping() {
        if (isTyping) return;
        
        // é¸æ“‡æ–‡ç« 
        if (essaySelect.value === 'upload') {
            if (userUploadedEssays.length === 0) {
                alert('è«‹å…ˆä¸Šå‚³è‡ªè¨‚æ–‡ç« æˆ–é¸æ“‡éš¨æ©Ÿæ–‡ç« ');
                return;
            }
            currentEssay = userUploadedEssays[Math.floor(Math.random() * userUploadedEssays.length)];
        } else if (essaySelect.value === 'random') {
            currentEssay = getRandomEssay();
        } else if (essaySelect.value === 'web' && !currentEssay) {
            alert('è«‹å…ˆä½¿ç”¨ã€Œç²å–æ–‡ç« ã€æŒ‰éˆ•å¾ç¶²é è¼‰å…¥æ–‡ç« ');
            return;
        }
        
        // åˆå§‹åŒ–å­—ç¬¦ç‹€æ…‹é™£åˆ—
        charStatus = new Array(currentEssay.length).fill(null);
        currentCharIndex = 0;
        
        // é‡ç½®ç‹€æ…‹
        resetTyping(true);
        
        // è¨­ç½®æ–‡ç« é¡¯ç¤º
        displayEssay();
        
        // å•Ÿç”¨è¼¸å…¥æ¡†
        textInput.disabled = false;
        textInput.focus();
        
        // è¨­ç½®è¨ˆæ™‚å™¨
        timeLeft = parseInt(timeSelect.value);
        updateTimerDisplay();
        
        timer = setInterval(function() {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft <= 0) {
                finishTyping();
            }
        }, 1000);
        
        startTime = new Date().getTime();
        isTyping = true;
        
        // æ–°å¢: å°‡ typing-area å›ºå®šåœ¨è¦–çª—é ‚éƒ¨
        const typingArea = document.querySelector('.typing-area');
        typingArea.style.position = 'sticky';
        typingArea.style.top = '0';
        typingArea.style.zIndex = '100';
        typingArea.style.backgroundColor = 'white'; // ç¢ºä¿èƒŒæ™¯ä¸é€æ˜
        window.scrollTo(0, typingArea.offsetTop);
    }

        // å®Œæˆæ‰“å­—ç·´ç¿’
        function finishTyping() {
            clearInterval(timer);
            isTyping = false;
            textInput.disabled = true;
            
            // è¨ˆç®—æœ€çµ‚çµ±è¨ˆæ•¸æ“š
            const elapsedTime = parseInt(timeSelect.value) - timeLeft;
            const minutes = elapsedTime / 60;
            const speed = Math.round(totalTyped / minutes);
            const accuracy = Math.round((correctTyped / totalTyped) * 100) || 0;
            
            speedDisplay.textContent = speed;
            accuracyDisplay.textContent = accuracy + '%';
            
            // é¡¯ç¤ºæ‰€æœ‰æ¨™è¨˜
            showAllMarkings();
            
            // æ¨™è¨˜æ‰“å­—æ¡†ä¸­çš„éŒ¯èª¤
            markInputErrors();
        }          
        
        // é‡ç½®æ‰“å­—ç·´ç¿’
   function resetTyping(keepEssay = false) {
        clearInterval(timer);
        isTyping = false;
        totalTyped = 0;
        correctTyped = 0;
        textInput.value = '';
        textInput.disabled = true;
        
        // ç§»é™¤è¼¸å…¥é¡¯ç¤ºdivï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const inputDisplay = document.getElementById('input-display');
        if (inputDisplay) {
            inputDisplay.remove();
            textInput.style.display = 'block';
        }
        
        // æ¢å¾© typing-area çš„æ¨£å¼
        const typingArea = document.querySelector('.typing-area');
        typingArea.style.position = '';
        typingArea.style.top = '';
        typingArea.style.zIndex = '';
        typingArea.style.backgroundColor = '';
        
        updateStats();
        
        if (!keepEssay) {
            // å¦‚æœä¸æ˜¯åœ¨é–‹å§‹ç·´ç¿’æ™‚èª¿ç”¨çš„é‡ç½®ï¼Œå‰‡é‡æ–°é¸æ“‡æ–‡ç« 
            if (essaySelect.value === 'random') {
                currentEssay = getRandomEssay();
            } else if (essaySelect.value === 'upload' && userUploadedEssays.length > 0) {
                currentEssay = userUploadedEssays[Math.floor(Math.random() * userUploadedEssays.length)];
            }
        }
        
        if (currentEssay) {
            displayEssay();
        }
    }
        
        // æ›´æ–°è¨ˆæ™‚å™¨é¡¯ç¤º
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = 
                (minutes < 10 ? '0' : '') + minutes + ':' + 
                (seconds < 10 ? '0' : '') + seconds;
        }
        
        // é¡¯ç¤ºæ–‡ç« 
        function displayEssay() {
            let html = '';
            for (let i = 0; i < currentEssay.length; i++) {
                if (currentEssay[i] === '\n') {
                    html += '<br>';
                } else if (currentEssay[i] === 'ã€€') {
                    html += '<span id="char-' + i + '" class="fullwidth-space">â–¡</span>';
                } else {
                    html += '<span id="char-' + i + '">' + currentEssay[i] + '</span>';
                }
            }
            textDisplay.innerHTML = html;
            
            // æ¨™è¨˜ç¬¬ä¸€å€‹å­—ç¬¦ç‚ºç•¶å‰
            markCurrentChar(0);
        }
        
// æ¨™è¨˜ç•¶å‰å­—ç¬¦
// æ¨™è¨˜ç•¶å‰å­—ç¬¦
function markCurrentChar(index) {
    // ç§»é™¤æ‰€æœ‰ç•¶å‰æ¨™è¨˜
    var currentChars = document.querySelectorAll('.current');
    for (var i = 0; i < currentChars.length; i++) {
        currentChars[i].classList.remove('current');
    }
    
    // å¦‚æœå·²ç¶“åˆ°é”æ–‡ç« æœ«å°¾ï¼Œå‰‡ä¸æ¨™è¨˜
    if (index >= currentEssay.length) return;
    
    // æ‰¾åˆ°å°æ‡‰æ–‡ç« ä½ç½®çš„å­—ç¬¦ï¼ˆä¸è·³éæ›è¡Œç¬¦ï¼‰
    var charElement = document.getElementById('char-' + index);
    if (charElement) {
        charElement.classList.add('current');
        
        // æª¢æŸ¥æ˜¯å¦æ˜¯æ–°çš„ä¸€è¡Œé–‹å§‹ï¼ˆç•¶å‰å­—ç¬¦æ˜¯æ›è¡Œç¬¦å¾Œçš„å­—ç¬¦ï¼‰
        const isNewLineStart = index > 0 && currentEssay[index-1] === '\n';
        
        // ç²å–ç•¶å‰è¡Œçš„å­—ç¬¦ç´¢å¼•ç¯„åœ
        let lineStart = index;
        while (lineStart > 0 && currentEssay[lineStart-1] !== '\n') {
            lineStart--;
        }
        let lineEnd = index;
        while (lineEnd < currentEssay.length && currentEssay[lineEnd] !== '\n') {
            lineEnd++;
        }
        
        // è¨ˆç®—ç•¶å‰å­—ç¬¦åœ¨è¡Œä¸­çš„ä½ç½®ï¼ˆå¾0é–‹å§‹ï¼‰
        const charInLinePos = index - lineStart;
        
        // åªåœ¨æ¯è¡Œçš„ç¬¬3å€‹å­—ç¬¦æª¢æŸ¥ä¸€æ¬¡æ»¾å‹•
        if (charInLinePos === 2) {
            const textDisplay = document.getElementById('text-display');
            const charRect = charElement.getBoundingClientRect();
            const textDisplayRect = textDisplay.getBoundingClientRect();
            
            // è¨ˆç®—é¡¯ç¤ºæ¡†çš„ä¸‹1/4ä½ç½® 0.75
            const lowerQuarter = textDisplayRect.top + textDisplayRect.height * 0.60;
            
            // å¦‚æœç•¶å‰å­—ç¬¦å·²ç¶“è¶…éä¸‹1/4ä½ç½®ï¼Œå‰‡æ»¾å‹•
            if (charRect.bottom > lowerQuarter) {
                // è¨ˆç®—æ»¾å‹•ä½ç½®ï¼Œä½¿ç•¶å‰è¡Œä½æ–¼é ‚éƒ¨
                const lineStartElement = document.getElementById('char-' + lineStart);
                if (lineStartElement) {
                    const lineStartRect = lineStartElement.getBoundingClientRect();
                    const scrollTop = lineStartRect.top - textDisplayRect.top + textDisplay.scrollTop;
                    textDisplay.scrollTop = scrollTop;
                }
            }
        }
    }
}
        
        // æª¢æŸ¥æ‰“å­—è¼¸å…¥
// æª¢æŸ¥æ‰“å­—è¼¸å…¥
    function checkTyping() {
        if (!isTyping || isComposing) return;
        
        const inputText = textInput.value;
        totalTyped = inputText.length;
        
        let correctCount = 0;
        let inputIndex = 0;
        let essayIndex = 0;
        
        // è™•ç†åˆªé™¤æ“ä½œï¼šç•¶è¼¸å…¥é•·åº¦æ¸›å°‘æ™‚ï¼Œé‡ç½®ç›¸æ‡‰å­—ç¬¦ç‹€æ…‹
        if (inputText.length < currentCharIndex) {
            // é‡ç½®å¾ç•¶å‰è¼¸å…¥é•·åº¦åˆ°ä¹‹å‰ currentCharIndex ä¹‹é–“çš„å­—ç¬¦ç‹€æ…‹
            for (let i = inputText.length; i < currentCharIndex && i < currentEssay.length; i++) {
                charStatus[i] = null;
                updateCharDisplay(i); // ç«‹å³æ›´æ–°é¡¯ç¤º
            }
            currentCharIndex = inputText.length;
        }
        
        // åªè™•ç†åˆ°ç•¶å‰æ‡‰è©²è™•ç†çš„å­—ç¬¦ç‚ºæ­¢
        while (inputIndex < inputText.length && essayIndex < currentEssay.length) {
            // è™•ç†æ›è¡Œç¬¦è™Ÿ
            if (currentEssay[essayIndex] === '\n') {
                if (inputText[inputIndex] === '\n') {
                    charStatus[essayIndex] = true; // æ¨™è¨˜ç‚ºæ­£ç¢º
                    correctCount++;
                    inputIndex++;
                }
                essayIndex++;
                continue;
            }
            
            // è·³éè¼¸å…¥ä¸­çš„æ›è¡Œç¬¦ï¼ˆå¦‚æœæ–‡ç« ç•¶å‰ä¸æ˜¯æ›è¡Œç¬¦ï¼‰
            if (inputText[inputIndex] === '\n') {
                inputIndex++;
                continue;
            }
            
            const expectedChar = currentEssay[essayIndex];
            const typedChar = inputText[inputIndex];
            
            // æª¢æŸ¥æ˜¯å¦åŒ¹é…ï¼ˆåŒ…æ‹¬ä¸­æ–‡æ¨™é»ç¬¦è™Ÿï¼‰
            if (typedChar === expectedChar || 
                isSpecialSpace(expectedChar) && isSpecialSpace(typedChar) ||
                isChinesePunctuation(expectedChar) && isChinesePunctuation(typedChar)) {
                charStatus[essayIndex] = true; // æ¨™è¨˜ç‚ºæ­£ç¢º
                correctCount++;
            } else {
                charStatus[essayIndex] = false; // æ¨™è¨˜ç‚ºéŒ¯èª¤
            }
            
            // å¦‚æœç·´ç¿’æ¨¡å¼é–‹å•Ÿï¼Œç«‹å³æ›´æ–°é¡¯ç¤º
            if (practiceMode.checked) {
                updateCharDisplay(essayIndex);
            }
            
            inputIndex++;
            essayIndex++;
        }
        
        // æ›´æ–°ç•¶å‰æ‡‰è©²è™•ç†çš„å­—ç¬¦ç´¢å¼•ï¼ˆä½¿ç”¨æ–‡ç« ä½ç½®è€Œéè¼¸å…¥ä½ç½®ï¼‰
        currentCharIndex = essayIndex;
        
        // æ¨™è¨˜ç•¶å‰å­—ç¬¦
        markCurrentChar(currentCharIndex);
        
        // è‡ªå‹•æ»¾å‹•è¼¸å…¥æ¡†
        textInput.scrollTop = textInput.scrollHeight;
        
        correctTyped = correctCount;
        updateStats();
        
        // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰æ–‡ç« å…§å®¹
        if (currentCharIndex >= currentEssay.length) {
            finishTyping();
        }
    }
        
        // æ›´æ–°å–®å€‹å­—ç¬¦çš„é¡¯ç¤º
        function updateCharDisplay(index) {
            const charSpan = document.getElementById('char-' + index);
            if (!charSpan) return;
            
            charSpan.classList.remove('correct', 'incorrect', 'finished-incorrect');
            
            if (charStatus[index] === true) {
                charSpan.classList.add('correct');
            } else if (charStatus[index] === false) {
                if (isTyping && practiceMode.checked) {
                    charSpan.classList.add('incorrect'); // ç·´ç¿’ä¸­é¡¯ç¤ºç´…è‰²éŒ¯èª¤
                } else {
                    charSpan.classList.add('finished-incorrect'); // çµæŸå¾Œé¡¯ç¤ºé»ƒè‰²éŒ¯èª¤
                }
            }
        }

        // æ¨™è¨˜æ‰“å­—æ¡†ä¸­çš„éŒ¯èª¤
        function markInputErrors() {
            const inputText = textInput.value;
            let html = '';
            let inputIndex = 0;
            let essayIndex = 0;
            
            while (inputIndex < inputText.length && essayIndex < currentEssay.length) {
                const char = inputText[inputIndex];
                
                // è™•ç†æ›è¡Œç¬¦
                if (currentEssay[essayIndex] === '\n') {
                    if (char === '\n') {
                        html += '<span class="input-correct">\n</span>';
                        inputIndex++;
                    } else {
                        html += '<span class="input-incorrect">' + char + '</span>';
                        inputIndex++;
                    }
                    essayIndex++;
                    continue;
                }
                
                // è·³éæ–‡ç« ä¸­çš„æ›è¡Œç¬¦
                if (char === '\n') {
                    html += '<span class="input-incorrect">\n</span>';
                    inputIndex++;
                    continue;
                }
                
                const expectedChar = currentEssay[essayIndex];
                
                if (char === expectedChar || 
                    isSpecialSpace(expectedChar) && isSpecialSpace(char) ||
                    isChinesePunctuation(expectedChar) && isChinesePunctuation(char)) {
                    html += '<span class="input-correct">' + char + '</span>';
                } else {
                    html += '<span class="input-incorrect">' + char + '</span>';
                }
                
                inputIndex++;
                essayIndex++;
            }
            
            // è™•ç†å¤šé¤˜çš„è¼¸å…¥å­—å…ƒ
            while (inputIndex < inputText.length) {
                html += '<span class="input-incorrect">' + inputText[inputIndex] + '</span>';
                inputIndex++;
            }
            
            // ä½¿ç”¨divä¾†é¡¯ç¤ºå¸¶æ¨£å¼çš„è¼¸å…¥å…§å®¹
            const inputDisplay = document.createElement('div');
            inputDisplay.id = 'input-display';
            inputDisplay.innerHTML = html;
            
            // æ›¿æ›åŸä¾†çš„textarea
            textInput.style.display = 'none';
            textInput.parentNode.insertBefore(inputDisplay, textInput);
        }

        // é¡¯ç¤ºæ‰€æœ‰æ­£ç¢º/éŒ¯èª¤æ¨™è¨˜
        function showAllMarkings() {
            for (let i = 0; i < charStatus.length; i++) {
                updateCharDisplay(i);
            }
        }
        
        // è¼”åŠ©å‡½å¼ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºç‰¹æ®Šç©ºæ ¼ï¼ˆå…¨å½¢æˆ–åŠå½¢ï¼‰
        function isSpecialSpace(char) {
            return char === ' ' || char === 'ã€€';
        }
        
        // è¼”åŠ©å‡½å¼ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºä¸­æ–‡æ¨™é»ç¬¦è™Ÿ
function isChinesePunctuation(char) {
    // æ“´å±•ä¸­æ–‡æ¨™é»ç¬¦è™Ÿåˆ—è¡¨
    const chinesePunctuation = /[ï¼Œã€‚ã€ï¼›ï¼šï¼Ÿï¼ã€Œã€ã€ã€ï¼ˆï¼‰ã€ã€‘ã€Šã€‹ï¹ï¹‚â€¦â€”ï½â€§]/;
    return chinesePunctuation.test(char);
}
        
        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            if (!isTyping) return;
            
            const elapsedTime = (parseInt(timeSelect.value) - timeLeft) / 60;
            const speed = Math.round(totalTyped / elapsedTime) || 0;
            const accuracy = Math.round((correctTyped / totalTyped) * 100) || 0;
            
            speedDisplay.textContent = speed;
            accuracyDisplay.textContent = accuracy + '%';
        }
    </script>
</body>
</html>